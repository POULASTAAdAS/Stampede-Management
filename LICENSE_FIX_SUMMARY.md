# License System Fix - February 4, 2026

## Issue Summary

License activation was failing with "No license found" error when pasting a valid license key generated by
`license_generator_tool.py` into the activation dialog in `license_manager.py`.

## Root Cause

There were **two critical mismatches** between `license_generator_tool.py` (the license generator) and
`license_manager.py` (the license validator):

### 1. Key Name Mismatch

- **Generator** used: `'customer'`
- **Validator** expected: `'customer_name'`

### 2. Signature Algorithm Mismatch

- **Generator** used: Simple string concatenation + SHA256
  ```python
  data_str = f"{machine_id}_{expires}_{valid}"
  signature = hashlib.sha256(data_str.encode() + secret_salt).hexdigest()
  ```

- **Validator** expected: JSON serialization + HMAC-SHA256
  ```python
  data_str = json.dumps(data, sort_keys=True)
  signature = hmac.new(secret_salt, data_str.encode(), hashlib.sha256).hexdigest()
  ```

## Fix Applied

### Modified File: `auth/license_generator_tool.py`

1. **Added HMAC import**:
   ```python
   import hmac  # Added to line 7
   ```

2. **Fixed key name** (line 109):
   ```python
   # Before:
   'customer': self.customer_entry.get().strip() or "N/A"
   
   # After:
   'customer_name': self.customer_entry.get().strip() or "N/A"
   ```

3. **Fixed signature generation** (lines 115-121):
   ```python
   # Before:
   data_str = f"{license_data['machine_id']}_{license_data['expires']}_{license_data['valid']}"
   signature = hashlib.sha256(data_str.encode() + self.manager.secret_salt).hexdigest()
   
   # After:
   data_str = json.dumps(license_data, sort_keys=True)
   signature = hmac.new(
       self.manager.secret_salt,
       data_str.encode(),
       hashlib.sha256
   ).hexdigest()
   ```

4. **Updated display** (line 135):
   ```python
   # Before:
   Customer: {license_data['customer']}
   
   # After:
   Customer: {license_data['customer_name']}
   ```

## Verification

Created and ran `test_license_fix.py` which confirms:

- ✓ License generation works correctly
- ✓ License validation works correctly
- ✓ Manual generation (simulating tool) works correctly
- ✓ Signature verification passes

### Test Output:

```
ALL TESTS PASSED [OK]

The license generation and validation are now working correctly!
You can now use license_generator_tool.py to generate licenses.
```

## How to Use Now

### 1. Generate License (Admin)

```bash
cd auth
python license_generator_tool.py
```

- Enter customer's Machine ID
- Set validity period (e.g., 365 days)
- Enter customer name
- Click "Generate License"
- Copy the generated JSON license key

### 2. Activate License (Customer)

1. Run the application
2. When activation dialog appears, paste the COMPLETE JSON license key:
   ```json
   {
     "machine_id": "...",
     "mac_address": "...",
     "username": "...",
     "customer_name": "...",
     "created": "...",
     "expires": "...",
     "valid": true,
     "signature": "..."
   }
   ```
3. Click "Activate License"
4. Should show: "License activated successfully!"

## Important Notes

- **Must paste the ENTIRE JSON block**, not just the signature
- The JSON must be properly formatted (as generated by the tool)
- Machine ID in the license must match the customer's machine
- The fix ensures signature validation now works correctly

## Files Modified

- `auth/license_generator_tool.py` - Fixed to match license_manager's validation logic

## Files Created

- `test_license_fix.py` - Verification script to test the fix

## Status

✓ **FIXED and TESTED** - License generation and activation now work correctly
